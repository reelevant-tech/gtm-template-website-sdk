___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Reelevant Website SDK",
  "categories": [
    "PERSONALIZATION"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Display individualized content on your website with Reelevant",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "eventConfiguration",
    "displayName": "Event configuration",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "SELECT",
        "name": "eventName",
        "displayName": "Event",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "boot",
            "displayValue": "Startup"
          },
          {
            "value": "simple-popup",
            "displayValue": "Trigger Popup"
          }
        ],
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "eventInfo",
        "displayName": "",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "LABEL",
            "name": "bootInfo",
            "displayName": "This event must be triggered when the page load to init sdk with user id",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "boot",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "simplepopupInfo",
            "displayName": "Place a simple popup that will automatically launch when the workflow send a content",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "simple-popup",
                "type": "EQUALS"
              }
            ]
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "eventConfig",
        "displayName": "Configuration",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "companyId",
            "displayName": "Company\u0027s ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "boot",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "globalUserId",
            "displayName": "User\u0027s id (optional)",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "boot",
                "type": "EQUALS"
              }
            ],
            "valueValidators": []
          },
          {
            "type": "TEXT",
            "name": "userId",
            "displayName": "User\u0027s id (optional)",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "simple-popup",
                "type": "EQUALS"
              }
            ],
            "valueValidators": []
          },
          {
            "type": "TEXT",
            "name": "workflowId",
            "displayName": "Workflow ID",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "simple-popup",
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "workflowEntrypoint",
            "displayName": "Workflow Channel ID",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "simple-popup",
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NUMBER"
              },
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "PARAM_TABLE",
            "name": "params",
            "displayName": "Parameters to be used by workflow",
            "paramTableColumns": [
              {
                "param": {
                  "type": "TEXT",
                  "name": "name",
                  "displayName": "Name",
                  "simpleValueType": true
                },
                "isUnique": true
              },
              {
                "param": {
                  "type": "TEXT",
                  "name": "value",
                  "displayName": "Value",
                  "simpleValueType": true
                },
                "isUnique": false
              }
            ],
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "simple-popup",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "PARAM_TABLE",
            "name": "styles",
            "displayName": "Custom style to be added to the trigger",
            "paramTableColumns": [
              {
                "param": {
                  "type": "TEXT",
                  "name": "css property name",
                  "displayName": "Name",
                  "simpleValueType": true
                },
                "isUnique": true
              },
              {
                "param": {
                  "type": "TEXT",
                  "name": "value",
                  "displayName": "Value",
                  "simpleValueType": true
                },
                "isUnique": false
              }
            ],
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "simple-popup",
                "type": "EQUALS"
              }
            ]
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const injectScript = require('injectScript');
const setInWindow = require('setInWindow');
const copyFromWindow = require('copyFromWindow');
const callInWindow = require('callInWindow');

// Utils
function transformParams (rawParams) {
  return rawParams.reduce((params, param) => {
    params[param.name] = param.value;
    return params;
  }, {});
}

// Global config
const eventName = data.eventName;

function onScriptLoaded () {
  log('Reelevant script injected!');
  if (typeof data.globalUserId === "string") {
    callInWindow('rlvt.identify', [data.globalUserId]);
  }
  data.gtmOnSuccess();
}
function onScriptFailure () {
  log('Injecting reelevant script failed');
  data.gtmOnFailure();
}

function main () {
  // Inject script and save global labels
  if (eventName === 'boot') {
      log('Injecting reelevant script');
      // Config script
      const companyId = data.companyId;
      const queue = copyFromWindow('rlvt.queue');
      setInWindow('rlvt', {
        companyId: companyId,
        queue: queue || []
      }, true);
      injectScript('https://scripts-repo.reelevant.com/web-sdk?company=' + companyId, onScriptLoaded, onScriptFailure);
      return;
  }
  log('Reelevant, triggering:', eventName);
  
  // Add queue only if rlvt doesn't exists yet
  setInWindow('rlvt', {
    queue: []
  }, false);

  // Handle event
  switch (eventName) {
    case 'simple-popup': {
      callInWindow('rlvt.queue.push', [{
        type: 'simple-popup',
        workflow: { id: data.workflowId, entrypoint: data.workflowEntrypoint },
        params: transformParams(data.params || []),
        backdrop: true,
        userId: data.userId,
        style: transformParams(data.style || [])
      }]);
      break;
    }
  }
  data.gtmOnSuccess();
}
main();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rlvt.queue.push"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rlvt"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rlvt.queue"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rlvt.identify"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://scripts-repo.reelevant.com/*"
              },
              {
                "type": 1,
                "string": "https://scripts-repo.staging.reelevant.io/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 22/12/2020 à 16:37:00


